<style>
  .track {
    position: relative;
  }



  .song-played-indicator,
  .song-play-button,
  .song-pause-button {
    visibility: hidden;
  }

  .track:hover .song-play-button {
    visibility: visible;
  }

  .track.active.playing .song-played-indicator {
    visibility: visible;
  }

  .track.active.playing .song-play-button {
    visibility: hidden;
  }

  .track.playing .action-pause:hover .song-played-indicator {
    visibility: hidden;
  }

  .track.playing .action-pause:hover .song-pause-button {
    visibility: visible;
  }

  .track .visible-hover-track {
    visibility: hidden;
  }

  .track:hover .visible-hover-track {
    visibility: visible;
  }





  .track.active .track-number,
  .track:hover .track-number {
    visibility: hidden;
  }

  track.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: inherit;
    /* Inherit the track's background color */
    z-index: -2;
    /* Ensure it’s behind other content but above the progress bar */
    border-radius: inherit;
    /* Ensures the pseudo-element respects the border-radius of the parent */
  }

  .track.active::after {
    transition: all 20ms;
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 10%;
    width: var(--background-width, 0%);
    /* Set this dynamically via JavaScript to change from 0% to 100% */
    background-color: rgba(255, 255, 255, 0.197);
    /* Example background color with some transparency */
    z-index: 0;
    /* Ensure it’s behind other content */
    /* border-radius: inherit; Ensures the pseudo-element respects the border-radius of the parent */
  }
</style>


<svg xmlns="http://www.w3.org/2000/svg" class="hidden">
  <symbol id="icon-related-tracks" viewBox="0 0 122.88 91.69">
    <path d="M49.58,0h11.34v3.79c28.37,6.5,31.61,20.12,15.16,41.59c1.75-21.3-0.4-25.87-15.16-26.86v53.86 c0.03,0.29,0.04,0.57,0.04,0.86c0,7-7.35,13.94-16.4,15.51c-9.06,1.57-16.4-2.84-16.4-9.84c0-9.55,13.12-17.84,21.43-14.92L49.58,0 L49.58,0L49.58,0z M72.31,91.69h-0.16c0-1.29-0.48-2.41-1.44-3.38c-0.96-0.96-2.09-1.44-3.38-1.44v-0.16 c1.29,0,2.41-0.48,3.38-1.44c0.96-0.97,1.44-2.09,1.44-3.37h0.16c0,1.29,0.48,2.41,1.44,3.37c0.96,0.96,2.09,1.44,3.38,1.44v0.16 c-1.29,0-2.41,0.48-3.38,1.44C72.79,89.27,72.31,90.4,72.31,91.69L72.31,91.69L72.31,91.69z M92.53,74.61l-0.4-0.03 c0.24-3.22-0.75-6.13-2.97-8.72s-4.94-4.01-8.17-4.25l0.03-0.4c3.22,0.25,6.13-0.75,8.72-2.97c2.59-2.23,4.01-4.95,4.25-8.16 l0.4,0.03c-0.24,3.22,0.75,6.13,2.97,8.72s4.94,4.01,8.17,4.25l-0.03,0.4c-3.22-0.25-6.13,0.75-8.72,2.97 C94.19,68.67,92.78,71.39,92.53,74.61L92.53,74.61L92.53,74.61z M109.33,42.87l-0.5,0.06c-0.52-4.13-2.51-7.55-5.99-10.26 c-3.47-2.71-7.28-3.8-11.42-3.29l-0.06-0.5c4.13-0.51,7.55-2.51,10.26-5.99s3.8-7.29,3.29-11.41l0.5-0.06 c0.52,4.13,2.51,7.55,5.99,10.26c3.48,2.71,7.28,3.8,11.42,3.29l0.06,0.5c-4.13,0.52-7.55,2.51-10.26,5.99 C109.91,34.93,108.82,38.74,109.33,42.87L109.33,42.87L109.33,42.87z M18.45,54.03c-2.3,0-4.17-1.87-4.17-4.17s1.87-4.17,4.17-4.17 h16.63c2.3,0,4.17,1.87,4.17,4.17s-1.87,4.17-4.17,4.17H18.45L18.45,54.03L18.45,54.03z M10.57,33.79c-2.3,0-4.17-1.87-4.17-4.17 c0-2.3,1.87-4.17,4.17-4.17h24.52c2.3,0,4.17,1.87,4.17,4.17c0,2.3-1.87,4.17-4.17,4.17H3.67L10.57,33.79L10.57,33.79z M4.17,13.55 C1.87,13.55,0,11.68,0,9.37c0-2.3,1.87-4.17,4.17-4.17h30.92c2.3,0,4.17,1.87,4.17,4.17c0,2.3-1.87,4.17-4.17,4.17L4.17,13.55 L4.17,13.55L4.17,13.55z" />
  </symbol>

  <symbol id="icon-headphones-not-working" viewBox="0 0 76 76" baseProfile="full" enable-background="new 0 0 76.00 76.00" xml:space="preserve">
    <path class="fill-base-content opacity-10" fill-opacity="1" stroke-linejoin="round" d="M 37.75,19L 38.25,19C 38.25,19 57,19 57,39C 57,48 55,51 54,52C 54,52 51,54 51.9999,51.25C 51.9999,48.9362 53,44 53,44C 53,44 54,44 54,39C 54,33 50,22.5 39,22.5L 37,22.5C 26,22.5 22,33 22,39C 22,44 23,44 23,44C 23,44 24.0001,48.9362 24.0001,51.25C 25,54 22,52 22,52C 21,51 19,48 19,39C 19,19 37.75,19 37.75,19 Z M 26.5533,39.1655C 28.194,38.9349 29.711,40.0781 29.9416,41.7188L 31.4725,52.6117C 31.7031,54.2524 30.56,55.7694 28.9192,56C 27.2785,56.2306 25.2615,55.0875 25.0309,53.4467L 23.5,42.5538C 23.2694,40.9131 24.9126,39.3961 26.5533,39.1655 Z M 49.4467,39.1655C 51.0874,39.3961 52.7306,40.9131 52.5,42.5538L 50.9691,53.4467C 50.7385,55.0875 48.7215,56.2306 47.0808,56C 45.44,55.7694 44.2969,54.2524 44.5275,52.6117L 46.0584,41.7188C 46.289,40.0781 47.806,38.9349 49.4467,39.1655 Z " />
  </symbol>

  <symbol id="icon-headphones" viewBox="0 0 24 24">
    <path d="M12 5a7 7 0 0 0-7 7v1h2.08c.67 0 1 0 1.26.13.23.12.41.3.53.53.13.25.13.59.13 1.26v4.16c0 .67 0 1-.13 1.26-.12.23-.3.41-.53.53-.25.13-.59.13-1.26.13H6.2c-1.12 0-1.68 0-2.1-.22a2 2 0 0 1-.88-.87C3.02 19.5 3 18.99 3 18v-6a9 9 0 1 1 18 0v6c0 .99-.01 1.5-.22 1.9a2 2 0 0 1-.87.88c-.43.22-.99.22-2.11.22h-.88c-.67 0-1 0-1.26-.13a1.2 1.2 0 0 1-.53-.53c-.13-.25-.13-.59-.13-1.26v-4.16c0-.67 0-1 .13-1.26.12-.23.3-.41.53-.53.25-.13.59-.13 1.26-.13H19v-1a7 7 0 0 0-7-7z" />
  </symbol>
  <symbol id="icon-spotify" viewBox="0 0 496 512" class="h-6 w-6">
    <path fill="#1ed760" d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8Z" />
    <path d="M406.6 231.1c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3zm-31 76.2c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm-26.9 65.6c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4z" />
  </symbol>
  <symbol id="icon-spotify-white" viewBox="0 0 496 512" class="h-6 w-6">
    <path class="fill-base-content hover:fill-primary" d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8Z" />
    <path d="M406.6 231.1c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3zm-31 76.2c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm-26.9 65.6c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4z" />
  </symbol>
  <symbol id="icon-spotify-no-circle" viewBox="0 0 496 512" class="h-6 w-6">
    <path d="M406.6 231.1c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3zm-31 76.2c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm-26.9 65.6c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4z" />

  </symbol>
  <symbol id="icon-spotify-just-circle" viewBox="0 0 496 512" class="h-6 w-6">

  </symbol>

  <symbol id="icon-apple" viewBox="0 0 48 48">
    <path fill="#f50057" d="M42,37c0,2.762-2.238,5-5,5H11c-2.761,0-5-2.238-5-5V11c0-2.762,2.239-5,5-5h26c2.762,0,5,2.238,5,5 V37z"></path>
    <path fill="#fff" d="M19.775,14.821C19.321,14.926,19,15.33,19,15.796V29c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3 s1.791,3,4,3s4-1.343,4-3V21.334c0-0.466,0.321-0.87,0.775-0.974l7.306-1.686C29.551,18.565,30,18.922,30,19.404V26 c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3s1.791,3,4,3s4-1.343,4-3V13.257c0-0.643-0.598-1.119-1.225-0.974L19.775,14.821z"></path>
  </symbol>
  <symbol id="icon-apple-white" viewBox="0 0 48 48">
    <path class="fill-base-content hover:fill-primary" d="M42,37c0,2.762-2.238,5-5,5H11c-2.761,0-5-2.238-5-5V11c0-2.762,2.239-5,5-5h26c2.762,0,5,2.238,5,5 V37z"></path>
    <path d="M19.775,14.821C19.321,14.926,19,15.33,19,15.796V29c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3 s1.791,3,4,3s4-1.343,4-3V21.334c0-0.466,0.321-0.87,0.775-0.974l7.306-1.686C29.551,18.565,30,18.922,30,19.404V26 c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3s1.791,3,4,3s4-1.343,4-3V13.257c0-0.643-0.598-1.119-1.225-0.974L19.775,14.821z"></path>
  </symbol>
  <symbol id="icon-apple-no-square" viewBox="0 0 48 48">
    <path d="M19.775,14.821C19.321,14.926,19,15.33,19,15.796V29c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3 s1.791,3,4,3s4-1.343,4-3V21.334c0-0.466,0.321-0.87,0.775-0.974l7.306-1.686C29.551,18.565,30,18.922,30,19.404V26 c0,0.552-0.448,1-1,1h-1c-2.209,0-4,1.343-4,3s1.791,3,4,3s4-1.343,4-3V13.257c0-0.643-0.598-1.119-1.225-0.974L19.775,14.821z"></path>
  </symbol>
  <symbol id="icon-plus" viewBox="0 0 16 16">
    <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
  </symbol>
  <symbol id="icon-playd" viewBox="0 0 210 210">
    <path d="M179.07,105L30.93,210V0L179.07,105z" />
  </symbol>
  <symbol id="icon-play" viewBox="0 0 384 512">
    <path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z" />
  </symbol>
  <symbol id="icon-pause" viewBox="0 0 320 512">
    <path d="M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z" />
  </symbol>
  <symbol id="icon-plus-circle_old" viewBox="0 0 512 512">
    <rect width="208" height="32" x="256" y="152" fill="var(--ci-primary-color, #fff)" class="ci-primary" />
    <rect width="288" height="32" x="176" y="256" fill="var(--ci-primary-color, #fff)" class="ci-primary" />
    <rect width="288" height="32" x="176" y="360" fill="var(--ci-primary-color, #fff)" class="ci-primary" />
    <polygon fill="var(--ci-primary-color, #fff)" points="192 152 128 152 128 88 96 88 96 152 32 152 32 184 96 184 96 248 128 248 128 184 192 184 192 152" class="ci-primary" />
  </symbol>
  <symbol id="icon-plus-circle" viewBox="0 0 24 24" fill="none">
    <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 12H12M12 12H16M12 12V16M12 12V8M12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21Z" />
  </symbol>
  <symbol id="icon-minus-circle" viewBox="0 0 24 24" fill="none" class="stroke-base-content">
    <circle cx="12" cy="12" r="10" stroke-width="1.5" />
    <path d="M15 12H9" stroke-width="1.5" stroke-linecap="round" />
  </symbol>
</svg>

<div class="fixed inset-0 bg-transparent z-50 pointer-events-auto hidden" id="block-interactions"></div>

<div class="w-64  bg-primary-content p-4 m-4 rounded-xl shadow-xl border-2 absolute z-50 invisible" id="track-options-contextual-menu">
  <!-- First Title -->
  <h2 class="text-lg font-semibold mb-2 text-primary">Add to playlist...</h2>
  <!-- First Section -->
  <div class="overflow-y-auto max-h-40 mb-4">

    <ul class="space-y-1">
      {% if g.user_playlists|length == 0 %}
      <div class="justify-center content-center">
        <a href="{{url_for('main.playlist_create')}}" class="block p-2 rounded-xl hover:bg-blue-950">Create Your First Playlist...</a>
      </div>
      {% else %}
      {% for playlist in g.user_playlists %}
      <li><a data-playlist-id="{{playlist.id}}" href="#" class="add-track-to-playlist block p-2 rounded-xl hover:bg-blue-950">{{playlist.title}}</a></li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>

  <!-- Second Title -->
  <h2 class="text-lg font-semibold mb-2 text-primary">Other</h2>
  <!-- Second Section -->
  <div class="overflow-y-auto max-h-40">
    <ul class="space-y-1">
      <li><a href="#" class="block p-2 rounded-xl hover:bg-blue-950">Option 1</a></li>

    </ul>
  </div>
</div>



<div class="w-full text-left mt-4">
  <div class="flex flex-col" id="tracklist">
    {% for track in tracks %}
    {% set loop_index = loop.index %}
    {% include 'track.html' %}
    {% endfor %}
  </div>
</div>
<audio id="audio-player" controls class="fixed  bottom-2 left-1/2 transform -translate-x-1/2 z-50 hidden">
  Your browser does not support the audio element.
</audio>

{% include 'js_process_ajax.html' %}

<script>
  function getClosestParentByClass(element, className) {
    while (element && element !== document) {
      if (element.classList.contains(className)) {
        return element;
      }
      element = element.parentElement;
    }
    return null;
  }

  audioPlayer = document.getElementById('audio-player');
  document.querySelectorAll('.play-track-preview').forEach(link => {
    link.addEventListener('click', function (event) {
      event.preventDefault(); // Prevent the default link behavior
      event.stopPropagation(); // Prevent the event from bubbling up

      const audioUrl = this.getAttribute('href');

      if (typeof player !== 'undefined' && player.getPlayerState() === 1) player.pauseVideo()

      if (audioPlayer.getAttribute('src') !== audioUrl) {
        audioPlayer.setAttribute('src', audioUrl);
        audioPlayer.load(); // Load the new audio source
      }
      //audioPlayer.classList.remove('hidden'); // Make the audio player visible
      audioPlayer.play(); // Start playing the audio
    });
  });




  document.querySelectorAll('.track .openRelatedTracks').forEach(link => {
    link.addEventListener('click', function (event) {
      event.stopPropagation();
      event.preventDefault();
      document.getElementById('overlay').classList.remove('hidden');
      const relatedTracksUrl = this.getAttribute('data-related-tracks-url');
      const relatedTracksCheckUrl = this.getAttribute('data-related_tracks-check-url');

      const onSuccess = (response) => { 
        window.location.href = relatedTracksUrl;
      }
      const onError = (error) => {
        document.getElementById('overlay').classList.add('hidden');
      }



      return processAjax(relatedTracksCheckUrl, 'GET', null, onSuccess, onError)


    });
  });

  document.querySelectorAll('.track .openTrackOnPlatform').forEach(link => {
    link.addEventListener('click', function (event) {
      event.stopPropagation();

    });
  });


  document.querySelectorAll('.track .add-track-to-recent-playlist').forEach(link => {
    link.addEventListener('click', function (event) {
      event.stopPropagation();
      event.preventDefault();
      const trackId = this.closest('.track').getAttribute('data-track-id');
      return addTrackToPlaylistLastUsed({ track_id: trackId })
        // .then(response => {
        //   if (response.status_code === 200) {
        //     console.log(response.message);
        //     showSystemMessage(response.message);
        //   } else { // Error handling
        //     if (response.redirect) {
        //       window.location.href = response.redirect;
        //     }
        //     console.log(response.error);
        //     showSystemMessage(response.error, 'warning');
        //   }
        // });

    });
  });


  //song-pause-button
  document.querySelectorAll('.track .song-pause-button').forEach(link => {
    link.addEventListener('click', function (event) {
      console.log('song-pause-button clicked')
      event.stopPropagation();
      if (typeof player !== 'undefined' && player.getPlayerState() === 1) player.pauseVideo()
      audioPlayer.pause();

    });
  });



  document.querySelectorAll('.track .song-play-button').forEach(link => {
    link.addEventListener('click', function (event) {
      console.log('song-play-button clicked')
      if (typeof player !== 'undefined') {
        event.stopPropagation();
        var playerState = player.getPlayerState();
        var track = getClosestParentByClass(this, 'track');
        var trackIsActive = track.classList.contains('active');

        if (!trackIsActive) {
          var trackStartTime = track.getAttribute('data-start_time');
          player.seekTo(trackStartTime);
        }

        player.playVideo();
        // if (playerState === 2 ){ // paused
        //   player.playVideo()
        // // }else{ // video not started yet
        // //   correspondingTrack = this.closest('.track');
        // //   trackStartTime = correspondingTrack.getAttribute('data-start_time');
        // //   console.log(trackStartTime);
        // //   player.seekTo(trackStartTime);

        // }
      }
    });
  });

  document.querySelectorAll('.track .trigger-track-contextual-menu').forEach(link => {
    link.addEventListener('click', function (event) {
      event.stopPropagation();
      event.preventDefault();
      showContextMenu(event, this);
    });
  });



  let trackWithContextMenu = null;


  const menu = document.getElementById('track-options-contextual-menu');
  const blockInteractions = document.getElementById('block-interactions');
  function showContextMenu(event, caller) {
    event.preventDefault();


    const rect = event.target.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    const bodyWidth = document.body.offsetWidth;
    const bodyHeight = window.innerHeight || document.documentElement.clientHeight;

    const computedStyle = window.getComputedStyle(menu);
    const menuWidth = menu.offsetWidth
      + parseFloat(computedStyle.marginLeft)
      + parseFloat(computedStyle.marginRight);

    const menuHeight = menu.offsetHeight
      + parseFloat(computedStyle.marginTop)
      + parseFloat(computedStyle.marginBottom);

    let menuLeft = rect.left + scrollLeft + rect.width;
    let menuTop = rect.top + scrollTop;

    // Check if the menu extends beyond the right edge of the page
    if (menuLeft + menuWidth > bodyWidth) {
      // Position the menu to the left of the target element if it does
      menuLeft = bodyWidth - menuWidth;
    }

    // Check if the menu extends beyond the bottom edge of the viewport
    if (menuTop + menuHeight > scrollTop + bodyHeight) {
      menuTop = scrollTop + bodyHeight - menuHeight;
    }

    // Check if the menu extends beyond the top edge of the viewport
    if (menuTop < scrollTop) {
      menuTop = scrollTop;
    }

    menu.style.top = `${menuTop}px`;
    menu.style.left = `${menuLeft}px`;
    menu.classList.remove('invisible');
    menu.classList.add('block');

    trackWithContextMenu = caller.closest('.track');
    trackWithContextMenu.classList.add('ring-2', 'ring-primary');

    blockInteractions.classList.remove('hidden');

    document.addEventListener('click', hideContextMenuOnClick);
    window.addEventListener('scroll', hideContextMenu);
  }

  function hideContextMenu() {
    menu.classList.remove('block');
    menu.classList.add('invisible');
    blockInteractions.classList.add('hidden');
    trackWithContextMenu.classList.remove('ring-2', 'ring-primary');
    document.removeEventListener('click', hideContextMenuOnClick);
  }

  function hideContextMenuOnClick(event) {
    // Check if the click was outside the menu


    if (!menu.contains(event.target)) {
      hideContextMenu();
    }

    event.stopPropagation();
  }


  document.querySelectorAll('.add-track-to-playlist').forEach(link => {
    link.addEventListener('click', function (event) {
      event.preventDefault();
      const trackId = trackWithContextMenu.getAttribute('data-track-id');
      const playlist_id = this.getAttribute('data-playlist-id');

      addTrackToPlaylist({ track_id: trackId, playlist_id: playlist_id })
        .then(response => {
          if (response.status_code === 200) {
            console.log(response.message);
            showSystemMessage(response.message);
          } else {
            console.log(response.error);
            showSystemMessage(response.error, 'warning');
          }
        });
    });
  });

  function addTrackToPlaylist(payload) {

    return processAjax('{{ url_for("main.jax_add_track_to_playlist") }}', 'POST', payload)
    // return fetch('{{ url_for("main.jax_add_track_to_playlist") }}', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json'
    //   },
    //   body: JSON.stringify(payload)
    // })
    //   .then(response => response.json()
    //     .then(result => ({
    //       status_code: response.status,
    //       message: result.message,
    //       error: result.error
    //     })))
    //   .catch(error => ({
    //     status_code: 500,
    //     error: 'Network error or server is down'
    //   }));
  }

  function addTrackToPlaylistLastUsed(payload) {

    payload.caller_url = window.location.href;
    return processAjax('{{ url_for("main.jax_add_track_to_playlist_last_used") }}', 'POST', payload)

    // return fetch('{{ url_for("main.jax_add_track_to_playlist_last_used") }}', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json'
    //   },
    //   body: JSON.stringify(payload)
    // })
    //   .then(response => response.json()
    //     .then(result => ({
    //       status_code: response.status,
    //       message: result.message,
    //       error: result.error,
    //       redirect: result.redirect
    //     })))
    //   .catch(error => ({
    //     status_code: 500,
    //     error: 'Network error or server is down'
    //   }));
  }




</script>