{% extends "base.html" %}

{% block content %}

<div class="flex justify-end  items-start p-4">
  <a href="{{url_for('set.add')}}" class="btn btn-primary">
    {{_("Add a set")}}
  </a>
</div>


<div class="container mx-auto py-8">
  <div class="flex justify-center">
    <div class="w-full max-w-5xl">


      <ul class="flex flex-wrap text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:border-gray-700 dark:text-gray-400">
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue') }}" class="{{'active ' if status==None }}inline-block p-4  bg-gray-100 rounded-t-lg  dark:bg-gray-800 ">All ({{count['all']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='prequeued') }}" class="{{'text-primary ' if status == 'prequeued' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Prequeued ({{count['prequeued']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='premiered') }}" class="{{'text-primary ' if status == 'premiered' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Premiered ({{count['premiered']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='discarded') }}" class="{{'text-primary ' if status=='discarded' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Discarded ({{count['discarded']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='pending') }}" class="{{'text-primary ' if status=='pending' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Pending ({{count['pending']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='processing') }}" class="{{'text-primary ' if status=='processing' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Processing ({{count['processing']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='done') }}" class="{{'text-primary ' if status=='done' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Done ({{count['done']}})</a>
        </li>
        <li class="me-2">
          <a href="{{ url_for('set.sets_queue',status='zero_track') }}" class="{{'text-primary ' if status=='zero_track' }}inline-block p-4  bg-gray-100 rounded-t-lg dark:bg-gray-800">Zero tracks ({{count['zero_track']}})</a>
        </li>
      </ul>
      </ul>
      {% if is_admin %}
      <div class="mt-4 text-xs float-right right-0 py-4">
        {% if include_15min_error ==1 %}
        <a href="{{url_for('set.sets_queue',status=status,page=page)}}">
          Exclude sets "Video shorter than 15m. errors"
        </a>
        {% else %}
        <a href="{{url_for('set.sets_queue',status=status,page=page,include_15min_error=1)}}">
          Include sets "Video shorter than 15m. errors"
        </a>
        {% endif %}
      </div>
      {% endif %}
      {% if sets %}
      <h2 class="text-2xl">All Sets</h2>
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pos</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ">Video</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Retries</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Queued/Updated</th>
            {% if is_admin %}
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for set in sets %}
          <tr>
            <td class="px-6 py-4 ">{{ loop.index }}</td>
            <td class="px-6 py-4">
              <div class="flex flex-row items-start space-x-2 ">
                <div class="flex-shrink-0">
                  {% if set.video_info_json %}
                  <img src="{{set.video_info_json.thumbnail}}" alt="" class="w-32 h-auto">
                  {% else %}
                  <img src="{{url_for('static',filename='im/placeholder_128x72.png')}}" alt="" class="w-32 h-auto">
                  {% endif %}
                </div>
                <div >
                  <div class="w-full flex">
                    <a target="_blank" href="https://www.youtube.com/watch?v={{set.video_id}}">
                      <svg class="w-6 h-6 fill-base-content hover:fill-primary inline ">
                        <use xlink:href="#icon-link-external"></use>
                      </svg>
                    </a>
                    
                    {% if set.set_id %}
                    {% set url = url_for('set.set', set_id=set.set_id) %}
                    
                    <a href="{{url}}" class="tooltip text-sm font-semibold line-clamp-1  max-w-[230px] text-left" title="{{set.video_info_json.title }}">{{set.video_info_json.title }}</a>
                    {% else %}
                    <span class="discreet text-sm font-semibold truncate max-w-xs">{{set.video_info_json.title if set.video_info_json else set.video_id}}</span>
                    {% endif %}
                    
                  </div>
                  <div class="discreet">{{set.video_info_json.channel}}</div>

                  {% if set.discarded_reason and set.status != 'done' %}
                  <div class="tooltip" data-tip="{{discarded_reason_to_ux(set.discarded_reason)}}">
                  <div class="text-sm text-red-500 truncate max-w-xs  px-4 pl-0">{{discarded_reason_to_ux(set.discarded_reason)}}</div>
                </div>
                  {% endif %}
                </div>


            </td>
            <td class="px-6 py-4 whitespace-nowrap text-left">
              <p class="text-sm">{{set.status}}</p>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
              <p class="text-sm">{{set.n_attempts}}</p>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <p class="text-sm">{{tpl_utils.time_ago(set.queued_at)}}</p>
              <p class="text-sm">{{tpl_utils.time_ago(set.updated_at)}}</p>
            </td>
            
            {% if is_admin %}
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-col items-right space-x-4 space-y-2">
                {% if set.status == 'failed' or set.status == 'processing' %}
                <a href="{{url_for('admin.queue_discard',queue_id=set.id)}}" class="btn btn-xs">Discard</a>
                {% endif %}
                <a href="{{url_for('admin.queue_reset',queue_id=set.id)}}" class="btn btn-xs">Reset</a>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-sm text-center">Nothing in queue.</p>
      {% endif %}
    </div>
  </div>

  <div class="mt-8 flex justify-center space-x-4">
    {% if is_paginated %}
    {% if pagination.prev_url %}
    <a href="{{ pagination.prev_url }}" class="px-4 py-2 btn-primary btn rounded-full">Previous</a>
    {% endif %}
    {% if pagination.next_url %}
    <a href="{{ pagination.next_url }}" class="px-4 py-2 btn-primary btn rounded-full">Next</a>
    {% endif %}
    {% endif %}
  </div>

</div>



{% endblock %}