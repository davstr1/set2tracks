{% extends "base.html" %}

{% block content %}

<style>
  /* allows interaction on playlist when player is over. 
otherwise player playerMetaWrap takes all width 
even where the player is not behind*/
  #playerMetaWrap {
    pointer-events: none;
    max-width: 100vw !important;
  }

  #playerWrap {
    max-width: 85vw !important;
    pointer-events: auto;
  }
</style>



<div class="md:flex md:justify-between md:items-start p-4 pl-0 pr-0">
  <div class="pl-2">

    <h1 class="lg:text-2xl"><span class="discreet block">Playlist from</span>
      <a target="_blank" href="https://youtu.be/{{set.video_id}}">{{set.title}}
        <svg class="w-6 h-6 fill-base-content hover:fill-primary inline ">
          <use xlink:href="#icon-link-external"></use>
        </svg>
      </a>
      {%if is_admin %}
      <a href="{{url_for('admin.set_visibility_toggle',set_id=set.id)}}" class="text-gray-600">[{{ "Show" if set.hidden else "Hide" }}]
      </a>
      {%endif%}
    </h1>

    <p class="text-gray-600">
      <a href="{{url_for('set.sets',s='channelid:'+set.channel.id|string)}}">{{ set.channel.author }}</a> - {{ tpl_utils.km_number(set.channel.channel_follower_count) }} subs
      {%if is_admin %}
      <a href="{{url_for('admin.channel_visibility_toggle',channel_id=set.channel.id)}}" class="text-gray-600">[{{ "Show" if set.channel.hidden else "Hide" }}
        ]</a>
      <a href="{{url_for('admin.channel_followability_toggle',channel_id=set.channel.id)}}">[ Make {%if set.channel.followable %}un{% endif %}followable ]</a>
      {%endif%}

    <p class="text-gray-600">@{{ tpl_utils.time_ago(set.publish_date,False) }} <!--- - {{ tpl_utils.km_number(set.view_count) }} views - {{ tpl_utils.km_number(set.like_count) }} likes --></p>
  </div>
  <div class="flex flex-col justify-start space-y-4 border b-1 p-4  mt-5 md:mt-0">
    {% if not set.playlist_id %}
    <a href="#" id="create-playlist-from-set-tracks" class="btn">
      Create Playlist from set tracks
    </a>
    {% else %}
    <a href="{{url_for('playlist.show_playlist',playlist_id=set.playlist_id)}}" class="btn">
      View playlist created from set tracks
    </a>
    {% endif %}
    <a href="" id="add_all_tracks_to_playlist" class="btn ">
      Add all tracks to playlist
    </a>
  </div>
</div>


<div id="playerMetaWrap" class="flex flex-col items-center  p-4 sticky top-0 z-50 ">

  <div id="playerWrap" class=" w-3/6  z-50 relative">

    <div id="modifyLeftMargin" class=" relative ">
      <div class="absolute  flex items-center   -left-5 h-full">
        <div id="draggable" class="cursor-ew-resize opacity-30 hover:opacity-100 h-2/6 w-3 bg-gray-500 rounded-xl select-none">&nbsp;</div>
      </div>

      <div id="videoWrap" class="relative  overflow-auto  p-2">
        <div id="youtubePlayer" class="aspect-video"></div>
      </div>

    </div>


  </div>
</div>

<div id="containerUnderPlayer">
  <h1 class="text-xl font-semibold mt-8 ">Playlist from Set</h1>
</div>

<p class="discreet italic">Timestamps are {% if not set.has_chapters %}approximate and{% endif %} auto-detected. <br />Accuracy may vary by genre, so relax and enjoy the surprises—sometimes it gets creative!</p>



{% set tracks = set.tracks %}
<div id="playlist-in-set">
  {% include 'tracklist.html' %}
</div>

<script>
  document.querySelector('#add_all_tracks_to_playlist').addEventListener('click', function (event) {
    event.stopPropagation();
    event.preventDefault();
    showContextMenu(event, this);
  });


</script>

</div>


<div class="fixed bottom-0 w-full  text-center bg-primary-content z-50 border-t-2 p-2 text-xs lg:p-4 lg:text-xl">
  <a target="_blank" href="https://youtu.be/{{set.video_id}}" class="hover:text-primary">
    ❤ Support your DJ!
    <span class="inline-block lg:inline">Like, comment, and subscribe on YouTube</span>
    <svg class="w-6 h-6 fill-current inline hover:fill-primary">
      <use xlink:href="#icon-link-external"></use>
    </svg>
  </a>
</div>


<script>

  const setId = '{{set.id}}';
  const draggable = document.getElementById('draggable');
  const modifyLeftMargin = document.getElementById('modifyLeftMargin');
  // @TODO : wrap classes are totally confusing
  const playerWrap = document.getElementById('playerWrap');
  const metaWrap = document.getElementById('playerMetaWrap');
  const playerTopWrap = playerWrap.parentElement;
  const videoWrap = document.getElementById('videoWrap');
  const containerUnderPlayer = document.getElementById('containerUnderPlayer');

  const h1 = document.querySelector('h1');
  let playerTopWrapHeight = playerTopWrap.offsetHeight;
  const playerVMargin = playerTopWrapHeight - playerWrap.offsetHeight;

  let VideoShrinkThresholdReached = false;
  const shrinkOnInitial = playerTopWrap.offsetTop;
  let shrinkOn = shrinkOnInitial;

  let isDragging = false;
  let startX;
  const playerFixedClasses = ['items-end', 'fixed', 'right-0'] // ,'animate-center-to-end'k'w-48', 'h-28', 'fixed', 'top-2', 'right-2'
  const playerScrolledClasses = ['items-center', 'sticky'] // ,'animate-end-to-center' ''right-2'','w-3/6', 'relative'





  function saveWrapWidth(width) {
    localStorage.setItem('wrapWidth', width);
    playerTopWrapHeight = modifyLeftMargin.offsetHeight + playerVMargin;


  }

  // Function to load the wrap width from localStorage
  function loadWrapWidth() {
    const wrapWidth = localStorage.getItem('wrapWidth');
    if (wrapWidth) {
      modifyLeftMargin.style.marginLeft = '0px';
      playerWrap.style.width = `${wrapWidth}px`;
    }
  }

  //

  window.addEventListener('load', function () {
    playerTopWrapHeight = playerTopWrap.offsetTop;
    shrinkOn = playerTopWrapHeight; // metaWrap.getBoundingClientRect().top +
    console.log('shrinkOn', shrinkOn)
    console.log('playerTopWrapHeight', playerTopWrapHeight)

  });

  window.addEventListener('DOMContentLoaded', loadWrapWidth);

  // Mouse events
  draggable.addEventListener('mousedown', (e) => {
    videoWrap.classList.add('pointer-events-none');
    isDragging = true;
    startX = e.clientX - modifyLeftMargin.offsetLeft;
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      handleDrag(e.clientX);
    }
  });

  document.addEventListener('mouseup', endDrag);

  // Touch events
  draggable.addEventListener('touchstart', (e) => {
    videoWrap.classList.add('pointer-events-none');
    isDragging = true;
    startX = e.touches[0].clientX - modifyLeftMargin.offsetLeft;
  });

  document.addEventListener('touchmove', (e) => {
    if (isDragging) {
      handleDrag(e.touches[0].clientX);
    }
  });

  document.addEventListener('touchend', endDrag);

  // Common functions
  function handleDrag(clientX) {
    let ml = clientX - startX;
    modifyLeftMargin.style.marginLeft = ml + 'px';
  }

  function endDrag() {
    if (isDragging) {
      isDragging = false;
      const wrapWidth = videoWrap.offsetWidth > 65 ? videoWrap.offsetWidth : 65;
      modifyLeftMargin.style.marginLeft = '0px';
      playerWrap.style.width = `${wrapWidth}px`;
      videoWrap.classList.remove('pointer-events-none');
      saveWrapWidth(wrapWidth);
    }
  }


  window.addEventListener('scroll', function () {
    if (!VideoShrinkThresholdReached && window.scrollY > shrinkOn) {
      containerUnderPlayer.style.marginTop = `${metaWrap.offsetHeight}px`;
      metaWrap.classList.add(...playerFixedClasses);

      metaWrap.classList.remove(...playerScrolledClasses);

      //h1.style.marginTop = `${playerTopWrapHeight}px`;

      // setTimeout(() => {
      //   playerWrap.classList.remove('transition-all', 'duration-300');
      // }, 300);

      VideoShrinkThresholdReached = true;
    } else if (VideoShrinkThresholdReached && window.scrollY <= shrinkOn) {
      metaWrap.classList.add(...playerScrolledClasses);
      metaWrap.classList.remove(...playerFixedClasses);
      containerUnderPlayer.style.marginTop = '';
      //h1.style.marginTop = '';

      VideoShrinkThresholdReached = false;
    }
  });



  const createPlaylistButton = document.getElementById('create-playlist-from-set-tracks');

  if (createPlaylistButton) {
    createPlaylistButton.addEventListener('click', function (e) {
      e.preventDefault();
      const payload = {
        "set_id": setId
      }

      return processAjax('{{ url_for("playlist.jax_create_playlist_from_set_tracks") }}', 'POST', payload);
    });
  }

</script>


{% endblock %}