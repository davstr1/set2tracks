{% extends "base.html" %}

{% block content %}

<style>
  /* allows interaction on playlist when player is over. 
otherwise player playerMetaWrap takes all width 
even where the player is not behind*/
  #playerMetaWrap {
    pointer-events: auto;
    max-width: 100vw !important;
  }

  #playerWrap {
    pointer-events: auto;
  }

  @media (min-width: 768px) {
    #playerWrap {
      max-width: 85vw !important;
    }
  }
</style>




<div class="-mx-3 lg:-mx-5">

  <div id="playerMetaWrap" class="md:flex md:flex-col md:items-center  md:p-4 md:top-0 md:z-20 ">

    <div id="playerWrap" class="w-full md:w-5/6  md:z-50 md:relative">

      <div id="modifyLeftMargin" class="relative">
        <div class="md:absolute  flex items-center   -left-5 h-full">
          <div id="draggable" class="hidden md:block cursor-ew-resize opacity-30 hover:opacity-100 h-2/6 w-3 bg-gray-500 rounded-xl select-none">&nbsp;</div>
        </div>

        <div id="videoWrap" class="relative  overflow-auto  md:p-2">
          <div id="youtubePlayer" class="aspect-video w-full"></div>
        </div>

      </div>


    </div>
  </div>



  <div class="sticky w-full md:relative md:w-auto" id="containerUnderPlayer">
    <div class="bg-[#131418] p-3 rounded-xl py-6 w-full">

      <h1 class="lg:text-2xl text-white font-bold">
        <a target="_blank" href="https://youtu.be/{{set.video_id}}">{{set.title}}
          <svg class="w-6 h-6 fill-base-content hover:fill-primary hidden md:inline ">
            <use xlink:href="#icon-link-external"></use>
          </svg>
        </a>
        {%if is_admin %}
        <a href="{{url_for('admin.set_visibility_toggle',set_id=set.id)}}" class="text-gray-600 hidden md:inline">[{{ "Show" if set.hidden else "Hide" }}]
        </a>
        {%endif%}
      </h1>
      <p class="text-gray-500">{{ tpl_utils.time_ago(set.publish_date,False) }} <!--- - {{ tpl_utils.km_number(set.view_count) }} views - {{ tpl_utils.km_number(set.like_count) }} likes --></p>
      <div class="text-gray-500 mt-5">
        <a class="font-bold" href="{{url_for('set.sets',s='channelid:'+set.channel.id|string)}}">{{ set.channel.author }}</a> <span class="ml-4">{{ tpl_utils.km_number(set.channel.channel_follower_count) }} subscribers</span>
        {%if is_admin %}
        <a class="hidden md:inline" href="{{url_for('admin.channel_visibility_toggle',channel_id=set.channel.id)}}" class="text-gray-600">[{{ "Show" if set.channel.hidden else "Hide" }}
          ]</a>
        <a class="hidden md:inline" href="{{url_for('admin.channel_followability_toggle',channel_id=set.channel.id)}}">[ Make {%if set.channel.followable %}un{% endif %}followable ]</a>
        {%endif%}
      </div>
      <!-- <div class="flex flex-col justify-start space-y-4 border b-1 p-4  mt-5 md:mt-0">
    {% if not set.playlist_id %}
    <a href="#" id="create-playlist-from-set-tracks" class="btn">
      Create Playlist from set tracks
    </a>
    {% else %}
    <a href="{{url_for('playlist.show_playlist',playlist_id=set.playlist_id)}}" class="btn">
      View playlist created from set tracks
    </a>
    {% endif %}
    <a href="" id="add_all_tracks_to_playlist" class="btn ">
      Add all tracks to playlist
    </a>
  </div> -->
    </div>


    <div class="flex justify-between items-center mt-8 mx-4">
      <div>
        <h2 class="text-xl font-semibold  text-white">Playlist</h2>
      </div>

      <div class="discreet text-xs">
        <svg class="w-4 h-4 fill-current inline">
          <use xlink:href="#icon-clock"></use>
        </svg>
        Timestamps are approximate
        <div class="hidden md:block">
          Accuracy may vary by genre. Relax and enjoy the surprises !
        </div>
      </div>
    </div>



    {% set tracks = set.tracks %}
    <div id="playlist-in-set">
      {% include 'tracklist.html' %}
    </div>

    <div class="bg-[#131418] p-3  py-10 w-full rounded-xl">
      <h1 class="lg:text-2xl text-white font-bold">
        <a target="_blank" href="https://youtu.be/{{set.video_id}}">{{set.title}}
          <svg class="w-6 h-6 fill-base-content hover:fill-primary hidden md:inline ">
            <use xlink:href="#icon-link-external"></use>
          </svg>
        </a>
        {%if is_admin %}
        <a href="{{url_for('admin.set_visibility_toggle',set_id=set.id)}}" class="text-gray-600 hidden md:inline">[{{ "Show" if set.hidden else "Hide" }}]
        </a>
        {%endif%}
      </h1>


      <div class="text-gray-500 mt-5 mb-10">
        <a class="font-bold" href="{{url_for('set.sets',s='channelid:'+set.channel.id|string)}}">{{ set.channel.author }}</a> <span class="ml-4">{{ tpl_utils.km_number(set.channel.channel_follower_count) }} subscribers</span>
        {%if is_admin %}
        <a class="hidden md:inline" href="{{url_for('admin.channel_visibility_toggle',channel_id=set.channel.id)}}" class="text-gray-600">[{{ "Show" if set.channel.hidden else "Hide" }}
          ]</a>
        <a class="hidden md:inline" href="{{url_for('admin.channel_followability_toggle',channel_id=set.channel.id)}}">[ Make {%if set.channel.followable %}un{% endif %}followable ]</a>
        {%endif%}
      </div>

      <hr>
      <p class="my-5">
        <a target="_blank" href="https://youtu.be/{{set.video_id}}" class="hover:text-primary">
          ‚ù§ Support your DJ!
          <span class="inline-block lg:inline">Like, comment, and subscribe on YouTube</span>
        </a>
      </p>
      <hr>

      <div class="mt-10 mb-5">Latest sets from this channel</div>

      <div class="overflow-x-auto pl-4">
        <div class="flex md:w-auto md:grid  md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for set in channel.sets_visible[:3] %}
          <div class="flex-shrink-0 w-5/6 md:w-auto overflow-hidden ">
            <a href="{{ url_for('set.set', set_id=set.id) }}">
              <div class="relative flex gap-0">
                <img src="{{ tpl_utils.youtube_thumbnail(set.thumbnail,'mqdefault') }}" alt="{{ set.title }}" class="w-full h-48 object-cover  rounded-lg">
                <div class="absolute inset-0 "></div>
                <div class="absolute bottom-0 right-0 p-2 m-2 text-white bg-black opacity-60 rounded-lg text-xs text-right">
                  <p>{{ set.duration // 60 }} m {# {{ set.duration % 60 }}s #}</p>
                  <p>{{ set.nb_tracks }} tracks</p>

                </div>
              </div>
            </a>
            <div class="p-4 text-sm">
              <a href="{{ url_for('set.set', set_id=set.id) }}">
                <h3 class="text-white font-semibold hover:text-primary">{{ set.title }}</h3>
              </a>
              <p class="text-gray-600">
                @{{ tpl_utils.time_ago(set.publish_date,False) }}
                <!-- - {{ tpl_utils.km_number(set.view_count) }} views
                - {{ tpl_utils.km_number(set.like_count) }} likes
                -->
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <p class="text-right">
        <a class="tooltip py-5" data-tip="See all sets from {{channel.author}}" href="{{url_for('set.sets',s='channelid:'~channel.id)}}">
          See all ({{channel.nb_sets_visible}})
        </a>
      </p>

    </div>

    <script>
      // document.querySelector('#add_all_tracks_to_playlist').addEventListener('click', function (event) {
      //   event.stopPropagation();
      //   event.preventDefault();
      //   showContextMenu(event, this);
      // });


    </script>

  </div>



</div>

<script>

  const setId = '{{set.id}}';
  const draggable = document.getElementById('draggable');
  const modifyLeftMargin = document.getElementById('modifyLeftMargin');
  // @TODO : wrap classes are totally confusing
  const playerWrap = document.getElementById('playerWrap');
  const metaWrap = document.getElementById('playerMetaWrap');
  const topMenuHeight = document.getElementById('topMenuWrap').offsetHeight;
  const playerTopWrap = playerWrap.parentElement;
  const videoWrap = document.getElementById('videoWrap');
  const containerUnderPlayer = document.getElementById('containerUnderPlayer');

  const h1 = document.querySelector('h1');
  let playerTopWrapHeight = playerTopWrap.offsetHeight;
  const playerVMargin = playerTopWrapHeight - playerWrap.offsetHeight;

  let VideoShrinkThresholdReached = false;
  const shrinkOnInitial = playerTopWrap.offsetTop;
  let shrinkOn = shrinkOnInitial;

  let isDragging = false;
  let startX;
  const playerFixedClasses = ['items-end', 'fixed', 'right-0'] // ,'animate-center-to-end'k'w-48', 'h-28', 'fixed', 'top-2', 'right-2'
  const playerScrolledClasses = ['items-center', 'sticky'] // ,'animate-end-to-center' ''right-2'','w-3/6', 'relative'





  function saveWrapWidth(width) {
    localStorage.setItem('wrapWidth', width);
    playerTopWrapHeight = modifyLeftMargin.offsetHeight + playerVMargin;


  }

  // Function to load the wrap width from localStorage
  function loadWrapWidth() {
    if (window.innerWidth < 768) {
      return;
    }
    const wrapWidth = localStorage.getItem('wrapWidth');
    if (wrapWidth) {
      modifyLeftMargin.style.marginLeft = '0px';
      playerWrap.style.width = `${wrapWidth}px`;
    }
  }

  //

  window.addEventListener('load', function () {
    playerTopWrapHeight = playerTopWrap.offsetTop;
    shrinkOn = metaWrap.offsetTop - 33; // bad approximation
    console.log('shrinkOn', shrinkOn)
    console.log('playerTopWrapHeight', playerTopWrapHeight)

  });

  window.addEventListener('DOMContentLoaded', loadWrapWidth);

  // Mouse events
  draggable.addEventListener('mousedown', (e) => {
    videoWrap.classList.add('pointer-events-none');
    isDragging = true;
    startX = e.clientX - modifyLeftMargin.offsetLeft;
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      handleDrag(e.clientX);
    }
  });

  document.addEventListener('mouseup', endDrag);

  // Touch events
  draggable.addEventListener('touchstart', (e) => {
    videoWrap.classList.add('pointer-events-none');
    isDragging = true;
    startX = e.touches[0].clientX - modifyLeftMargin.offsetLeft;
  });

  document.addEventListener('touchmove', (e) => {
    if (isDragging) {
      handleDrag(e.touches[0].clientX);
    }
  });

  document.addEventListener('touchend', endDrag);

  // Common functions
  function handleDrag(clientX) {
    let ml = clientX - startX;
    modifyLeftMargin.style.marginLeft = ml + 'px';
  }

  function endDrag() {
    if (isDragging) {
      isDragging = false;
      const wrapWidth = videoWrap.offsetWidth > 120 ? videoWrap.offsetWidth : 120;
      modifyLeftMargin.style.marginLeft = '0px';
      playerWrap.style.width = `${wrapWidth}px`;
      videoWrap.classList.remove('pointer-events-none');
      saveWrapWidth(wrapWidth);
    }
  }


  window.addEventListener('scroll', function () {
    // if page width is less than 768px, do not shrink the video
    if (window.innerWidth < 768) {
      return;
    }
    if (!VideoShrinkThresholdReached && window.scrollY > shrinkOn) {
      let newMargin = topMenuHeight + metaWrap.offsetHeight;
      console.log('topMenuHeight', topMenuHeight)
      console.log('metaWrap.offsetHeight', metaWrap.offsetHeight)
      metaWrap.style.top = `${topMenuHeight}px`;
      containerUnderPlayer.style.marginTop = `${newMargin}px`;
      metaWrap.classList.add(...playerFixedClasses);

      metaWrap.classList.remove(...playerScrolledClasses);

      //h1.style.marginTop = `${playerTopWrapHeight}px`;

      // setTimeout(() => {
      //   playerWrap.classList.remove('transition-all', 'duration-300');
      // }, 300);

      VideoShrinkThresholdReached = true;
    } else if (VideoShrinkThresholdReached && window.scrollY <= shrinkOn) {
      metaWrap.classList.add(...playerScrolledClasses);
      metaWrap.classList.remove(...playerFixedClasses);
      containerUnderPlayer.style.marginTop = '';
      //h1.style.marginTop = '';

      VideoShrinkThresholdReached = false;
    }
  });





</script>


{% endblock %}